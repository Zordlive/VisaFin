{% load i18n static %}

<div class="module" id="user-recent-actions-module" style="margin-bottom: 20px;">
    <h2>{% trans 'Actions rÃ©centes des utilisateurs' %}</h2>
    
    <div class="actions-tabs" style="margin-bottom: 15px; border-bottom: 2px solid #e1e4e8;">
        <button class="action-tab active" data-filter="all" style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid #417690; font-weight: bold; cursor: pointer; color: #417690;">
            Toutes les actions
        </button>
        <button class="action-tab" data-filter="deposit" style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; color: #666;">
            DÃ©pÃ´ts
        </button>
        <button class="action-tab" data-filter="withdrawal" style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; color: #666;">
            Retraits
        </button>
        <button class="action-tab" data-filter="password_reset" style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; color: #666;">
            RÃ©initialisations
        </button>
    </div>

    {% if user_recent_actions %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Date & Heure</th>
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Utilisateur</th>
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Action</th>
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">DÃ©tails</th>
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Statut</th>
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Action rapide</th>
            </tr>
        </thead>
        <tbody id="actions-table-body">
            {% for action in user_recent_actions %}
            <tr class="action-row" data-action-type="{{ action.action_type }}" style="border-bottom: 1px solid #dee2e6; {% cycle 'background-color: #ffffff;' 'background-color: #f8f9fa;' %}">
                <td style="padding: 12px; color: #6c757d; font-size: 13px;">
                    <strong>{{ action.timestamp|date:"d/m/Y" }}</strong><br>
                    <span style="color: #adb5bd;">{{ action.timestamp|date:"H:i:s" }}</span>
                </td>
                <td style="padding: 12px;">
                    <a href="{% url 'admin:auth_user_change' action.user_id %}" style="color: #417690; text-decoration: none; font-weight: 500;">
                        {{ action.user_name }}
                    </a>
                    {% if action.user_email %}
                    <br><span style="color: #6c757d; font-size: 12px;">{{ action.user_email }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px;">
                    <span class="action-badge" style="
                        padding: 4px 12px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                        {% if action.action_type == 'deposit' %}
                            background-color: #d1ecf1;
                            color: #0c5460;
                        {% elif action.action_type == 'withdrawal' %}
                            background-color: #fff3cd;
                            color: #856404;
                        {% elif action.action_type == 'password_reset' %}
                            background-color: #f8d7da;
                            color: #721c24;
                        {% else %}
                            background-color: #e2e3e5;
                            color: #383d41;
                        {% endif %}
                    ">
                        {{ action.action_display }}
                    </span>
                </td>
                <td style="padding: 12px; font-size: 13px;">
                    {{ action.details|safe }}
                </td>
                <td style="padding: 12px;">
                    <span style="
                        padding: 4px 10px;
                        border-radius: 8px;
                        font-size: 11px;
                        font-weight: 600;
                        {% if action.status == 'completed' or action.status == 'success' %}
                            background-color: #d4edda;
                            color: #155724;
                        {% elif action.status == 'pending' %}
                            background-color: #fff3cd;
                            color: #856404;
                        {% elif action.status == 'processing' %}
                            background-color: #d1ecf1;
                            color: #0c5460;
                        {% elif action.status == 'failed' or action.status == 'rejected' %}
                            background-color: #f8d7da;
                            color: #721c24;
                        {% else %}
                            background-color: #e2e3e5;
                            color: #383d41;
                        {% endif %}
                    ">
                        {{ action.status_display }}
                    </span>
                </td>
                <td style="padding: 12px;">
                    {% if action.admin_url %}
                    <a href="{{ action.admin_url }}" class="button" style="
                        display: inline-block;
                        padding: 6px 12px;
                        background-color: #417690;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: 500;
                        transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='#2e5469'" onmouseout="this.style.backgroundColor='#417690'">
                        {% if action.action_type == 'deposit' or action.action_type == 'withdrawal' %}
                            GÃ©rer â†’
                        {% else %}
                            Voir dÃ©tails â†’
                        {% endif %}
                    </a>
                    {% else %}
                    <span style="color: #adb5bd; font-size: 12px;">â€”</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; text-align: center;">
        <a href="{% url 'admin:api_deposit_changelist' %}" style="color: #417690; text-decoration: none; margin-right: 15px; font-weight: 500;">
            ðŸ“¥ Voir tous les dÃ©pÃ´ts
        </a>
        <a href="{% url 'admin:api_withdrawal_changelist' %}" style="color: #417690; text-decoration: none; margin-right: 15px; font-weight: 500;">
            ðŸ“¤ Voir tous les retraits
        </a>
        <a href="{% url 'admin:auth_user_changelist' %}" style="color: #417690; text-decoration: none; font-weight: 500;">
            ðŸ‘¥ Voir tous les utilisateurs
        </a>
    </div>
    
    {% else %}
    <p style="padding: 20px; text-align: center; color: #6c757d;">
        Aucune action rÃ©cente des utilisateurs.
    </p>
    {% endif %}
</div>

<script>
(function() {
    // Gestion des onglets de filtrage
    const tabs = document.querySelectorAll('.action-tab');
    const rows = document.querySelectorAll('.action-row');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Retirer la classe active de tous les onglets
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottom = '2px solid transparent';
                t.style.color = '#666';
                t.style.fontWeight = 'normal';
            });
            
            // Ajouter la classe active Ã  l'onglet cliquÃ©
            this.classList.add('active');
            this.style.borderBottom = '2px solid #417690';
            this.style.color = '#417690';
            this.style.fontWeight = 'bold';
            
            const filter = this.dataset.filter;
            
            // Filtrer les lignes
            rows.forEach(row => {
                if (filter === 'all' || row.dataset.actionType === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
    
    // Auto-refresh toutes les 30 secondes
    setInterval(function() {
        location.reload();
    }, 30000);
})();
</script>

<style>
#user-recent-actions-module {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
    background: white;
    padding: 20px;
}

#user-recent-actions-module h2 {
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 3px solid #417690;
    color: #417690;
    font-size: 18px;
}

.action-row:hover {
    background-color: #e9ecef !important;
    transition: background-color 0.2s;
}

@media (max-width: 768px) {
    .actions-tabs {
        overflow-x: auto;
        white-space: nowrap;
    }
    
    table {
        font-size: 12px;
    }
    
    td, th {
        padding: 8px !important;
    }
}
</style>
