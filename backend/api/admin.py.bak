from django.contrib import admin
from .models import MarketOffer, Wallet, Transaction, Deposit, Investor
from .models import ReferralCode, Referral, VIPLevel, UserVIPSubscription, Operateur, UserBankAccount
from .models import Withdrawal, AdminNotification, CryptoAddress
from .admin_site import admin_site  # Import notre AdminSite personnalisé


class MarketOfferAdmin(admin.ModelAdmin):
class MarketOfferAdmin(admin.ModelAdmin):
    list_display = ('title', 'price_offered', 'status', 'created_at')


@admin_site.register(Wallet)
class WalletAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'currency', 'available', 'pending', 'gains')


@admin_site.register(Transaction)
class TransactionAdmin(admin.ModelAdmin):
    list_display = ('id', 'wallet', 'amount', 'type', 'created_at')


@admin_site.register(Deposit)
class DepositAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'amount', 'currency', 'status', 'created_at')


@admin_site.register(Investor)
class InvestorAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'phone', 'total_invested', 'portfolio_value', 'created_at')


@admin_site.register(ReferralCode)
class ReferralCodeAdmin(admin.ModelAdmin):
    list_display = ('id', 'code', 'referrer', 'created_at')


@admin_site.register(Referral)
class ReferralAdmin(admin.ModelAdmin):
    list_display = ('id', 'code', 'referred_user', 'status', 'created_at', 'used_at')


@admin_site.register(VIPLevel)
class VIPLevelAdmin(admin.ModelAdmin):
    list_display = ('id', 'level', 'title', 'price', 'percentage', 'daily_gains', 'delay_days', 'created_at')
    list_filter = ('level',)
    search_fields = ('title', 'description')
    ordering = ('level',)


@admin_site.register(UserVIPSubscription)
class UserVIPSubscriptionAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'vip_level', 'purchased_at', 'active')
    list_filter = ('active', 'vip_level')
    search_fields = ('user__username', 'user__email')
    raw_id_fields = ('user', 'vip_level')


@admin_site.register(Operateur)
class OperateurAdmin(admin.ModelAdmin):
    list_display = ('id', 'operateur', 'nom_agent', 'numero_agent', 'created_at')
    list_filter = ('operateur',)
    search_fields = ('nom_agent', 'numero_agent')
    ordering = ('operateur', 'nom_agent')


@admin_site.register(UserBankAccount)
class UserBankAccountAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'account_type', 'account_holder_name', 'account_number', 'is_default', 'is_active', 'created_at')
    list_filter = ('account_type', 'is_active', 'is_default')
    search_fields = ('user__username', 'user__email', 'account_holder_name', 'account_number', 'bank_name', 'operator_name')
    raw_id_fields = ('user',)
    ordering = ('-is_default', '-created_at')


@admin_site.register(Withdrawal)
class WithdrawalAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'amount', 'bank', 'account', 'status', 'processed_by', 'created_at')
    list_filter = ('status', 'created_at')
    search_fields = ('user__username', 'user__email', 'bank', 'account')
    raw_id_fields = ('user', 'processed_by')
    readonly_fields = ('created_at', 'updated_at', 'processed_at')
    ordering = ('-created_at',)
    
    fieldsets = (
        ('Informations de l\'utilisateur', {
            'fields': ('user',)
        }),
        ('Détails du retrait', {
            'fields': ('amount', 'bank', 'account', 'status')
        }),
        ('Traitement administrateur', {
            'fields': ('processed_by', 'processed_at', 'reason_rejected')
        }),
        ('Horodatage', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )


@admin_site.register(AdminNotification)
class AdminNotificationAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'notification_type', 'amount', 'is_read', 'created_at')
    list_filter = ('notification_type', 'is_read', 'created_at')
    search_fields = ('user__username', 'user__email', 'account_info')
    raw_id_fields = ('user', 'admin', 'deposit', 'withdrawal')
    readonly_fields = ('created_at',)
    ordering = ('-created_at',)
    
    fieldsets = (
        ('Notifications', {
            'fields': ('admin', 'user', 'notification_type', 'amount')
        }),
        ('Détails du compte', {
            'fields': ('account_info',)
        }),
        ('Statut', {
            'fields': ('is_read', 'deposit', 'withdrawal')
        }),
        ('Horodatage', {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )


@admin_site.register(CryptoAddress)
class CryptoAddressAdmin(admin.ModelAdmin):
    list_display = ('network', 'address_preview', 'is_active', 'updated_at')
    list_filter = ('network', 'is_active')
    search_fields = ('address',)
    ordering = ('network',)
    
    fieldsets = (
        ('Informations du réseau', {
            'fields': ('network', 'address', 'is_active')
        }),
        ('Horodatage', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    readonly_fields = ('created_at', 'updated_at')
    
    def address_preview(self, obj):
        """Affiche un aperçu de l'adresse."""
        if len(obj.address) > 30:
            return f"{obj.address[:15]}...{obj.address[-15:]}"
        return obj.address
    address_preview.short_description = 'Adresse'


# Enregistrer les modèles Django par défaut (User, Group) dans notre admin personnalisé
from django.contrib.auth.models import User, Group
from django.contrib.auth.admin import UserAdmin, GroupAdmin

admin_site.register(User, UserAdmin)
admin_site.register(Group, GroupAdmin)
